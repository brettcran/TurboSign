<!-- Gold Version 2.1 Base (Fixed openSettings) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>TurboSign 2.1 Gold</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" href="logo.png" sizes="192x192"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<style>
  body {margin:0;font-family:Arial,sans-serif;background:#f5f5f5;color:#333;}
  .toolbar {width:100%;height:60px;background:#2f2f2f;position:fixed;top:0;left:0;display:flex;justify-content:space-around;align-items:center;padding:5px;z-index:1000;box-shadow:0 2px 5px rgba(0,0,0,0.4);border-radius:0 0 12px 12px;}
  .toolbar button {background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;font-size:26px;color:#fff;transition:all .3s ease;border-radius:6px;padding:4px 8px;}
  .toolbar button:hover {color:#4CAF50;background:rgba(76,175,80,0.1);transform:scale(1.1);}
  .toolbar button.active {border:2px solid #4CAF50;}
  #pdf-container {margin-top:60px;padding:20px;overflow-y:auto;height:calc(100vh - 60px);position:relative;background:#eee;}
  canvas {display:block;margin:20px auto;background:#fff;border:1px solid #ccc;}
  .draggable {position:absolute;cursor:move;user-select:text;font-family:Arial,sans-serif;white-space:pre-wrap;color:#000;font-size:15px;min-width:50px;min-height:20px;padding:2px;resize:both;overflow:auto;}
  .draggable.focused {outline:1px dashed #4CAF50;}
  .placeholder {color:#888;}
  #backdrop {display:none;position:fixed;width:100%;height:100%;top:0;left:0;background:rgba(0,0,0,0.5);z-index:1000;}
  .modal {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#333;padding:20px 30px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.3);min-width:300px;z-index:1001;}
  .modal h2 {margin-top:0;font-size:20px;color:#2f2f2f;text-align:center;margin-bottom:20px;}
  .modal button:not(.close-btn) {display:block;width:100%;margin:10px 0;padding:8px 12px;border:none;border-radius:6px;background:#2f2f2f;color:#fff;cursor:pointer;transition:all .3s ease;}
  .modal button:not(.close-btn):hover {background:#4CAF50;}
  .modal button.active {border:2px solid #4CAF50;}
  .modal .close-btn {position:absolute;top:10px;right:15px;font-size:24px;cursor:pointer;background:none;border:none;color:#555;}
  .modal .close-btn:hover {color:#f00;}
  #sig-canvas {display:block;margin:15px auto;border:1px solid #ccc;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
</style>
</head>
<body>
<div class="toolbar">
  <button onclick="triggerUpload()">üìÇ<span style="font-size:12px;">Open</span></button>
  <button id="btn-text" onclick="setMode('text')">T<span style="font-size:12px;">Text</span></button>
  <button id="btn-stamps" onclick="openStampModal()">üñ®Ô∏è<span style="font-size:12px;">Stamps</span></button>
  <button id="btn-sign" onclick="openSignatureModal()">‚úç<span style="font-size:12px;">Sign</span></button>
  <button id="btn-settings" onclick="openSettings()">‚öô<span style="font-size:12px;">Settings</span></button>
  <button id="btn-save" onclick="openSaveModal()">‚¨á<span style="font-size:12px;">Save</span></button>
</div>
<input type="file" id="file-input" accept="application/pdf" style="display:none"/>
<div id="pdf-container"></div>
<div id="backdrop" onclick="closeModals()"></div>

<div id="stamp-modal" class="modal">
  <button class="close-btn" onclick="closeModals()">√ó</button>
  <h2>Select Stamp</h2>
  <button id="btn-stamp-check" onclick="selectStamp('stamp-check')">üñ®Ô∏è‚úî Check</button>
  <button id="btn-stamp-x" onclick="selectStamp('stamp-x')">üñ®Ô∏è‚úñ X</button>
  <button id="btn-stamp-rect" onclick="selectStamp('stamp-rect')">üñ®Ô∏è‚ñ≠ Rect</button>
</div>

<div id="settings-modal" class="modal">
  <button class="close-btn" onclick="closeModals()">√ó</button>
  <h2>Text Settings</h2>
  <label>Font:<select id="font-family"><option>Arial</option><option>Verdana</option><option>Courier New</option></select></label>
  <label>Size:<select id="font-size"><option>10</option><option selected>15</option><option>20</option><option>30</option></select></label>
  <label>Color:<input type="color" id="font-color" value="#000000"/></label>
  <button onclick="applySettings()">Apply</button>
  <button onclick="resetDefaults()">Reset</button>
</div>

<div id="signature-modal" class="modal">
  <button class="close-btn" onclick="closeModals()">√ó</button>
  <h2>Draw Signature</h2>
  <canvas id="sig-canvas" width="500" height="200"></canvas>
  <button onclick="clearSignature()">Clear</button>
  <button onclick="saveSignature()">Save</button>
</div>

<div id="save-modal" class="modal">
  <button class="close-btn" onclick="closeModals()">√ó</button>
  <h2>Save PDF</h2>
  <label>File Name:<input type="text" id="save-filename" placeholder="exported.pdf"/></label>
  <button onclick="exportWithFilename()">Download</button>
</div>

<script>
const fileInput = document.getElementById('file-input');
const container = document.getElementById('pdf-container');
let currentMode = null;
let defaultFont = 'Arial', defaultSize = 15, defaultColor = '#000';
let signatureData = null;

function triggerUpload() {
  fileInput.click();
  hideToolbarActive();
}

function setMode(mode) {
  currentMode = currentMode === mode ? null : mode;
  updateToolbarActive();
}

function openStampModal() {
  showModal('stamp-modal');
  updateStampButtons();
}

function selectStamp(mode) {
  currentMode = mode;
  updateStampButtons();
  updateToolbarActive();
}

function openSettings() {
  showModal('settings-modal');
}

function openSignatureModal() {
  showModal('signature-modal');
  initSignaturePad();
}

function openSaveModal() {
  showModal('save-modal');
}

function closeModals() {
  document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
  document.getElementById('backdrop').style.display = 'none';
  updateToolbarActive();
}

function showModal(id) {
  document.getElementById(id).style.display = 'block';
  document.getElementById('backdrop').style.display = 'block';
}

function updateToolbarActive() {
  ['text', 'stamp-check', 'stamp-x', 'stamp-rect', 'sign'].forEach(m => {
    const btn = document.querySelector(`.toolbar button[onclick*="${m}"]`);
    if (btn) btn.classList.toggle('active', currentMode === m);
  });
}

function hideToolbarActive() {
  document.querySelectorAll('.toolbar button.active').forEach(b => b.classList.remove('active'));}

function updateStampButtons() {
  ['stamp-check', 'stamp-x', 'stamp-rect'].forEach(m => {
    const btn = document.getElementById(`btn-${m}`);
    if (btn) btn.classList.toggle('active', currentMode === m);
  });
}

function applySettings() {
  defaultFont = document.getElementById('font-family').value;
  defaultSize = parseInt(document.getElementById('font-size').value);
  defaultColor = document.getElementById('font-color').value;
  document.querySelectorAll('.draggable').forEach(el => {
    el.style.fontFamily = defaultFont;
    el.style.fontSize = defaultSize + 'px';
    el.style.color = defaultColor;
  });
}

function resetDefaults() {
  defaultFont = 'Arial'; defaultSize = 15; defaultColor = '#000';
  document.getElementById('font-family').value = 'Arial';
  document.getElementById('font-size').value = '15';
  document.getElementById('font-color').value = '#000000';
  applySettings();
}

function initSignaturePad() {
  const canvas = document.getElementById('sig-canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
  canvas.addEventListener('mouseup', () => { drawing = false; });
  canvas.addEventListener('mousemove', e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
  canvas.addEventListener('touchstart', e => {
    e.preventDefault(); drawing = true;
    const rect = canvas.getBoundingClientRect(); const t = e.touches[0]; ctx.beginPath(); ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
  }, { passive: false });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault(); if (drawing) { const rect = canvas.getBoundingClientRect(); const t = e.touches[0]; ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top); ctx.stroke(); }
  }, { passive: false });
  canvas.addEventListener('touchend', () => { drawing = false; });
}

function clearSignature() { const c = document.getElementById('sig-canvas'); c.getContext('2d').clearRect(0,0,c.width,c.height); }
function saveSignature() { signatureData = document.getElementById('sig-canvas').toDataURL(); closeModals(); }

async function renderPDF(file) { const data = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({ data }).promise; container.innerHTML = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const viewport = page.getViewport({ scale:1.25 }); const c = document.createElement('canvas'); c.width = viewport.width; c.height = viewport.height; const ct = c.getContext('2d'); await page.render({ canvasContext:ct, viewport }).promise; container.appendChild(c); } }
fileInput.addEventListener('change', e => { if (e.target.files[0]) renderPDF(e.target.files[0]); });

function placeAnnotation(cx, cy) { const rect = container.getBoundingClientRect(); const x = cx - rect.left + container.scrollLeft; const y = cy - rect.top + container.scrollTop; if (currentMode === 'text') { const el = document.createElement('div'); el.contentEditable = true; el.spellcheck = false; el.className = 'draggable placeholder focused'; el.style.fontFamily = defaultFont; el.style.fontSize = defaultSize + 'px'; el.style.color = defaultColor; el.style.left = x + 'px'; el.style.top = y + 'px'; el.textContent = 'Edit text'; container.appendChild(el); enableDrag(el); el.addEventListener('focus', () => { el.classList.add('focused'); if (el.classList.contains('placeholder')) { el.textContent = ''; el.classList.remove('placeholder'); } }); el.addEventListener('blur', () => { el.classList.remove('focused'); if (el.textContent.trim() === '') { el.textContent = 'Edit text'; el.classList.add('placeholder'); } }); } else if (['stamp-check','stamp-x','stamp-rect','sign'].includes(currentMode)) { let el; if (currentMode === 'sign' && signatureData) { el = document.createElement('img'); el.src = signatureData; el.style.maxWidth = '300px'; } else if (currentMode === 'stamp-check' || currentMode === 'stamp-x') { el = document.createElement('div'); el.className = 'draggable'; el.textContent = (currentMode === 'stamp-check' ? '‚úî' : '‚úñ'); el.style.fontSize = '32px'; el.style.color = '#000'; } else { el = document.createElement('div'); el.className = 'draggable'; el.style.border = '4px solid #000'; el.style.borderRadius = '8px'; el.style.background = 'transparent'; el.style.width = '100px'; el.style.height = '60px'; } el.style.left = x + 'px'; el.style.top = y + 'px'; container.appendChild(el); enableDrag(el); } }
container.addEventListener('dblclick', e => { placeAnnotation(e.clientX, e.clientY); });
container.addEventListener('touchend', e => { const t = e.changedTouches[0]; placeAnnotation(t.clientX, t.clientY); });
container.addEventListener('click', e => { const el = e.target.closest('.draggable'); if (!el) return; el.contentEditable = true; el.focus(); });

function enableDrag(el) { let offX = 0, offY = 0, drag = false; el.addEventListener('mousedown', ev => { if (!el.classList.contains('focused')) { drag = true; offX = ev.clientX - parseFloat(el.style.left || 0); offY = ev.clientY - parseFloat(el.style.top || 0); ev.preventDefault(); } }); el.addEventListener('touchstart', ev => { drag = true; const t = ev.touches[0]; offX = t.clientX - parseFloat(el.style.left || 0); offY = t.clientY - parseFloat(el.style.top || 0); ev.preventDefault(); }, {passive:false}); document.addEventListener('mouseup', () => { drag = false; }); document.addEventListener('touchend', () => { drag = false; }); document.addEventListener('mousemove', ev => { if (drag) { el.style.left = (ev.clientX - offX) + 'px'; el.style.top = (ev.clientY - offY) + 'px'; } }); document.addEventListener('touchmove', ev => { if (drag) { const t = ev.touches[0]; el.style.left = (t.clientX - offX) + 'px'; el.style.top = (t.clientY - offY) + 'px'; ev.preventDefault(); } }, {passive:false}); }

async function exportWithFilename() { const filename = document.getElementById('save-filename').value || 'exported.pdf'; await generatePDF(filename); closeModals(); }
async function generatePDF(fn) { const { PDFDocument, rgb } = window.PDFLib; const doc = await PDFDocument.create(); const canvases = document.querySelectorAll('#pdf-container canvas'); for (const c of canvases) { const pg = doc.addPage([c.width, c.height]); const img = await doc.embedJpg(c.toDataURL('image/jpeg', 0.8)); pg.drawImage(img, { x:0, y:0, width:c.width, height:c.height }); const elems = document.querySelectorAll('.draggable'); for (const el of elems) { const r = el.getBoundingClientRect(), cr = c.getBoundingClientRect(); const x = r.left - cr.left + container.scrollLeft; const y = c.height - (r.top - cr.top) - r.height + container.scrollTop; if (el.tagName === 'IMG') { const png = await doc.embedPng(el.src); pg.drawImage(png, { x, y, width:r.width, height:r.height }); } else { pg.drawText(el.textContent, { x, y, size:parseInt(el.style.fontSize) || 15, color:rgb(...hexToRgb(el.style.color || '#000')) }); } } } const bytes = await doc.save(); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' })); a.download = fn; a.click(); }

function hexToRgb(h) { h = h.replace('#',''); if (h.length === 3) h = h.split('').map(c => c+c).join(''); const n = parseInt(h, 16); return [((n>>16)&255)/255, ((n>>8)&255)/255, (n&255)/255]; }
</script>
</body>
</html>
