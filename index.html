<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TurboSign 3.3.4 — PDF Annotator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  :root{
    --bg:#0f131a; --fg:#e9eef5; --panel:rgba(255,255,255,.08); --border:rgba(255,255,255,.14);
    --btn:#1c2430; --btn-hov:#263244; --icon:#e9eef5; --canvas-bg:#fff;
    --ok:#16a34a; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--fg)}

  /* Toolbar */
  #toolbar{
    position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; padding:10px; border-radius:28px; z-index:40;
    background:var(--panel); border:1px solid var(--border); backdrop-filter:blur(10px);
    max-width:95vw; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  #toolbar::-webkit-scrollbar{ display:none }
  .btn{
    appearance:none; border:1px solid var(--border); background:var(--btn); color:var(--icon);
    width:52px; height:52px; border-radius:50%; display:grid; place-items:center;
    cursor:pointer; transition:background .2s, transform .08s; flex:0 0 auto;
  }
  .btn:hover{ background:var(--btn-hov) }
  .btn:active{ transform:translateY(1px) }
  .btn svg{ width:22px; height:22px; stroke:var(--icon) }
  @media (max-width:480px){ .btn{ width:46px; height:46px } .btn svg{ width:20px; height:20px } }

  /* Pages & overlay */
  #pdf-container{ position:relative; min-height:60vh; padding-bottom:110px }
  .page-wrap{ position:relative; width:max(320px, 72vw); margin:28px auto; transform-origin:0 0 }
  canvas.pdfpage{ display:block; width:100%; height:auto; background:var(--canvas-bg); border-radius:6px; touch-action:none }
  .overlay{ position:absolute; inset:0; }
  .draggable{ position:absolute; cursor:move; user-select:none; color:#000; touch-action:none }
  .text-anno{ font:16px Arial, sans-serif; color:#000; padding:2px 4px; background:transparent; min-width:10px; min-height:16px; cursor:text }
  .icon-anno svg{ width:26px; height:26px }
  .resizable{ border:1px dashed #9aa; background:transparent; resize:both; overflow:hidden }
  .resizable img{ width:100%; height:100%; display:block }

  /* Modals */
  .modal{
    display:none; position:fixed; inset:50% auto auto 50%; transform:translate(-50%,-50%);
    z-index:50; background:rgba(20,24,32,.94); color:var(--fg);
    border:1px solid var(--border); border-radius:14px; width:min(92vw,540px); max-height:90vh; overflow:auto;
    box-shadow:0 10px 40px rgba(0,0,0,.45); padding:14px
  }
  .modal.active{ display:block }
  .modal h3{ margin:8px 0 10px; font-size:18px }
  .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .chip{ appearance:none; border:1px solid var(--border); background:var(--btn); color:var(--icon); border-radius:10px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer }
  .chip svg{ width:18px; height:18px }

  /* Toast */
  #toast{ position:fixed; top:12px; left:50%; transform:translateX(-50%);
    background:#0b1020d0; color:#eaf2ff; padding:8px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.18); z-index:60; font-size:13px; display:none }
  #toast.show{ display:block; animation:fade .2s ease-out }
  #toast.ok{ box-shadow:0 0 0 1px var(--ok) inset } #toast.err{ box-shadow:0 0 0 1px var(--err) inset }
  @keyframes fade{ from{opacity:0; transform:translateX(-50%) translateY(-6px)} to{opacity:1} }
</style>
</head>
<body>
  <input id="file-input" type="file" accept="application/pdf,.pdf" style="display:none" />

  <div id="toolbar" aria-label="Tools">
    <button class="btn" data-act="open" title="Open PDF"><i data-feather="folder"></i></button>
    <button class="btn" data-act="text" title="Text"><i data-feather="type"></i></button>
    <button class="btn" data-act="stamp" title="Stamp (✓/✕/□)"><i data-feather="check-circle"></i></button>
    <button class="btn" data-act="sign" title="Signature"><i data-feather="edit-2"></i></button>
    <button class="btn" data-act="zoomin" title="Zoom In"><i data-feather="zoom-in"></i></button>
    <button class="btn" data-act="zoomout" title="Zoom Out"><i data-feather="zoom-out"></i></button>
    <button class="btn" data-act="undo" title="Undo"><i data-feather="rotate-ccw"></i></button>
    <button class="btn" data-act="redo" title="Redo"><i data-feather="rotate-cw"></i></button>
    <button class="btn" data-act="help" title="Help"><i data-feather="help-circle"></i></button>
    <button class="btn" data-act="settings" title="Text Settings"><i data-feather="sliders"></i></button>
    <button class="btn" data-act="save" title="Save PDF"><i data-feather="download"></i></button>
  </div>

  <div id="pdf-container"></div>

  <!-- Stamp picker -->
  <div id="stamp-modal" class="modal">
    <h3>Choose a stamp</h3>
    <div class="row">
      <button class="chip" data-stamp="check"><i data-feather="check-circle"></i> Check</button>
      <button class="chip" data-stamp="x"><i data-feather="x"></i> Cross</button>
      <button class="chip" data-stamp="square"><i data-feather="square"></i> Box</button>
    </div>
  </div>

  <!-- Signature pad -->
  <div id="sign-modal" class="modal">
    <h3>Signature</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="chip" data-sp="pen"><i data-feather="edit"></i> Pen</button>
      <button class="chip" data-sp="eraser"><i data-feather="eraser"></i> Eraser</button>
      <button class="chip" data-sp="undo"><i data-feather="rotate-ccw"></i> Undo</button>
      <button class="chip" data-sp="redo"><i data-feather="rotate-cw"></i> Redo</button>
      <button class="chip" data-sp="clear"><i data-feather="trash-2"></i> Clear</button>
    </div>
    <div class="row" style="gap:10px; margin-bottom:8px">
      <label class="chip"> Color <input id="sp-color" type="color" value="#000000" style="margin-left:8px"/></label>
      <label class="chip"> Size <input id="sp-size" type="range" min="1" max="48" value="4" style="margin-left:8px"/></label>
      <label class="chip"> Smooth <input id="sp-smooth" type="range" min="0" max="0.9" step="0.05" value="0.5" style="margin-left:8px"/></label>
    </div>
    <div class="row" style="gap:0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff;">
      <canvas id="sp-view" width="360" height="160" style="display:block; max-width:100%; height:auto; background:#fff; touch-action:none"></canvas>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="chip" id="sp-ok"><i data-feather="check"></i> Use</button>
      <button class="chip" id="sp-cancel"><i data-feather="x-circle"></i> Close</button>
    </div>
  </div>

  <!-- Help -->
  <div id="help-modal" class="modal">
    <h3>How to use TurboSign</h3>
    <ul>
      <li><b>Open:</b> folder icon → choose a PDF.</li>
      <li><b>Place:</b> choose Text / Stamp / Signature, then <b>double-tap</b> (or double-click).</li>
      <li><b>Move:</b> drag any item. <b>Resize signatures & stamps</b> by <b>pinch</b> (phones) or <b>Alt + wheel</b> (desktop). Text: focus then <b>Ctrl/Cmd + “+ / −”</b>.</li>
      <li><b>Zoom:</b> use +/− in the toolbar.</li>
      <li><b>Save:</b> flattens everything into a new PDF. On iOS, Share → <b>Save to Files</b>.</li>
    </ul>
    <div class="row" style="margin-top:8px"><button class="chip" id="help-close"><i data-feather="x-circle"></i> Close</button></div>
  </div>

  <!-- Settings -->
  <div id="settings-modal" class="modal">
    <h3>Text Settings</h3>
    <div class="row" style="gap:12px; margin-bottom:10px">
      <label class="chip"> Size
        <input id="set-text-size" type="range" min="8" max="64" step="1" value="16" style="margin-left:8px; width:180px">
        <span id="set-size-val" style="margin-left:6px; opacity:.9">16 px</span>
      </label>
      <label class="chip"> Font
        <select id="set-text-font" style="margin-left:8px">
          <option value="Arial, sans-serif">Arial</option>
          <option value="Helvetica, Arial, sans-serif">Helvetica</option>
          <option value="Verdana, Geneva, sans-serif">Verdana</option>
          <option value="'Trebuchet MS', Helvetica, sans-serif">Trebuchet MS</option>
          <option value="'Times New Roman', Times, serif">Times New Roman</option>
          <option value="Georgia, 'Times New Roman', Times, serif">Georgia</option>
          <option value="'Courier New', Courier, monospace">Courier New</option>
          <option value="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif">System UI</option>
        </select>
      </label>
    </div>
    <div class="row" style="gap:8px; margin-bottom:10px">
      <div id="set-preview" style="padding:8px 10px; background:#fff; color:#111; border-radius:8px;">
        The quick brown fox — preview
      </div>
    </div>
    <div class="row">
      <button class="chip" id="set-apply-all"><i data-feather="type"></i> Apply to existing text</button>
      <button class="chip" id="set-close"><i data-feather="x-circle"></i> Close</button>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Icons first -->
  <script src="https://unpkg.com/feather-icons@4.29.2/dist/feather.min.js"></script>

  <!-- PDF.js: local (if present) + CDN fallback -->
  <script src="pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Worker hint (helps some setups). If blocked, we auto-fallback to disableWorker anyway. -->
  <script>
    window.__PDFJS_WORKER__ = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- PDF-LIB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ---------- icons ---------- */
function drawFeather(container=document){ if(window.feather?.replace){ feather.replace({container}); } }
document.addEventListener('DOMContentLoaded', ()=> drawFeather(document));

/* ---------- toast ---------- */
const toastEl=document.getElementById('toast');
function toast(msg,type='ok',ms=1800){ toastEl.textContent=msg; toastEl.className=''; toastEl.classList.add('show',type); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms); }

/* ---------- elements & state ---------- */
const fileInput = document.getElementById('file-input');
const pdfContainer = document.getElementById('pdf-container');
const stampModal = document.getElementById('stamp-modal');
const signModal = document.getElementById('sign-modal');
const helpModal = document.getElementById('help-modal');
const settingsModal = document.getElementById('settings-modal');

let currentMode=null, signatureData=null, activeWrap=null, openedFileName=null;
let zoom=1; const ZMIN=.6, ZMAX=2.5, ZSTEP=0.15;

/* ---------- text defaults ---------- */
const TEXT_DEFAULTS = { size: 16, font: "Arial, sans-serif" };
const sizeInput = document.getElementById('set-text-size');
const sizeVal   = document.getElementById('set-size-val');
const fontSel   = document.getElementById('set-text-font');
const previewEl = document.getElementById('set-preview');
function refreshPreview(){ if(!previewEl) return; previewEl.style.fontSize=(sizeInput?.value||16)+'px'; previewEl.style.fontFamily=(fontSel?.value||TEXT_DEFAULTS.font); }
sizeInput.value=TEXT_DEFAULTS.size; sizeVal.textContent=TEXT_DEFAULTS.size+' px'; fontSel.value=TEXT_DEFAULTS.font; refreshPreview();

/* ---------- history ---------- */
const historyMap=new Map(); const HMAX=60;
function ensureHist(w){ if(!historyMap.has(w)) historyMap.set(w,{undo:[],redo:[]}); return historyMap.get(w); }
function overlayOf(w){ let ov=w.querySelector('.overlay'); if(!ov){ov=document.createElement('div'); ov.className='overlay'; w.appendChild(ov);} return ov; }
function pushUndo(w){ const h=ensureHist(w); const ov=overlayOf(w); if(h.undo.length>=HMAX) h.undo.shift(); h.undo.push(ov.innerHTML); h.redo.length=0; }
function restoreOverlay(w,html){ const ov=overlayOf(w); ov.innerHTML=html||''; ov.querySelectorAll('.draggable').forEach(bindDrag); }

/* ---------- toolbar ---------- */
document.getElementById('toolbar').addEventListener('click', (e)=>{
  const btn=e.target.closest('.btn'); if(!btn) return;
  const act=btn.dataset.act;
  if(act==='open'){ fileInput.click(); }
  else if(act==='text'){ currentMode='text'; toast('Double-tap to place text'); }
  else if(act==='stamp'){ stampModal.classList.add('active'); drawFeather(stampModal); }
  else if(act==='sign'){ openSign(); drawFeather(signModal); }
  else if(act==='zoomin'){ setZoom(zoom+ZSTEP); }
  else if(act==='zoomout'){ setZoom(zoom-ZSTEP); }
  else if(act==='undo'){ const w=activeWrap||pdfContainer.querySelector('.page-wrap'); if(!w) return; const h=ensureHist(w); if(h.undo.length){ const s=h.undo.pop(); h.redo.push(overlayOf(w).innerHTML); restoreOverlay(w,s);} }
  else if(act==='redo'){ const w=activeWrap||pdfContainer.querySelector('.page-wrap'); if(!w) return; const h=ensureHist(w); if(h.redo.length){ const s=h.redo.pop(); h.undo.push(overlayOf(w).innerHTML); restoreOverlay(w,s);} }
  else if(act==='help'){ helpModal.classList.add('active'); drawFeather(helpModal); }
  else if(act==='settings'){ openSettings(); drawFeather(settingsModal); }
  else if(act==='save'){ savePdf(); }
});

/* ---------- PDF.js bootstrap + engine check ---------- */
function pdfjsAvailable(){ return !!window.pdfjsLib; }
async function ensurePdfEngine(){
  if(!pdfjsAvailable()){
    // Give scripts time to load (CDN fallback) before we declare missing.
    await new Promise(r=>setTimeout(r, 200));
  }
  if(!pdfjsAvailable()){
    throw newErr('E_ENGINE_MISSING', 'PDF engine failed to load (pdfjsLib is undefined). Check network/AdBlock/CSP.');
  }
  try{
    // Prefer a working CDN worker; if blocked we will fallback to disableWorker later.
    pdfjsLib.GlobalWorkerOptions.workerSrc = (window.__PDFJS_WORKER__ || "pdf.worker.min.js");
  }catch(e){}
}

/* ---------- robust error builder & logger ---------- */
function newErr(code, message, cause){
  const e = new Error(message);
  e.code = code; if(cause) e.cause = cause;
  return e;
}
function errString(err){
  try{
    if(!err) return '(no error value)';
    if(err instanceof Error){
      return `[${err.code||err.name}] ${err.message}${err.stack?'\n'+err.stack:''}`;
    }
    if(typeof err === 'object') return JSON.stringify(err, Object.getOwnPropertyNames(err));
    return String(err);
  }catch(_){ return '(unprintable error)'; }
}
function logError(prefix, err){
  console.groupCollapsed(prefix);
  console.error(err);
  try{
    const obj = (err && typeof err==='object') ? err : { value: err };
    console.table({
      code: obj.code||'(n/a)',
      name: obj.name||'(n/a)',
      message: obj.message||'(n/a)'
    });
    if(obj.stack) console.log('stack:', obj.stack);
  }catch(_){}
  console.groupEnd();
}

/* ---------- open & render with bulletproof diagnostics ---------- */
fileInput.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f){ return; }

  // Accept PDFs even when type is empty (iOS) by checking extension.
  const name=f.name||''; const extOk=/\.pdf$/i.test(name); const typeOk=(f.type==='application/pdf');
  if(!(extOk||typeOk)){ const msg='Selected file is not a PDF'; toast(msg,'err'); logError('[Open PDF] Non-PDF', {name, type:f.type}); return; }
  if(f.size===0){ const msg='PDF file is empty (0 bytes)'; toast(msg,'err'); logError('[Open PDF] Empty file', {name}); return; }

  openedFileName=name.replace(/\.[Pp][Dd][Ff]$/,'') || 'document';

  try{
    await ensurePdfEngine();
    const buf=await f.arrayBuffer();
    await openAndRender(buf);
    toast('PDF loaded');
  }catch(err){
    const msg = humanOpenError(err);
    toast(msg,'err',2800);
    logError('[Open PDF] Error detail', err);
  }
});

function humanOpenError(err){
  const s = errString(err);
  if(/Password|Incorrect Password|NEED_PASSWORD/i.test(s)) return 'Password required or incorrect';
  if(/InvalidPDF|FormatError/i.test(s)) return 'Invalid or corrupted PDF';
  if(/MissingPDF/i.test(s)) return 'PDF missing or unreadable';
  if(/ENGINE_MISSING|pdfjsLib is undefined/i.test(s)) return 'PDF engine failed to load';
  if(/Worker|importScripts|Blocked|NetworkError|SecurityError/i.test(s)) return 'Worker blocked — retried on main thread and failed';
  return 'Failed to open PDF';
}

async function openAndRender(bytes){
  await ensurePdfEngine();
  // try with worker first
  try{
    const pdf = await tryOpen(bytes, {disableWorker:false});
    return renderPdf(pdf);
  }catch(e1){
    // Password?
    if(isPasswordError(e1)){
      const pw = prompt('Enter PDF password:');
      if(pw===null) throw newErr('E_PW_CANCEL','Password entry canceled', e1);
      try{
        const pdf = await tryOpen(bytes, {disableWorker:false, password:pw});
        return renderPdf(pdf);
      }catch(e1b){
        // fallback to main thread with same password
        try{
          const pdf = await tryOpen(bytes, {disableWorker:true, password:pw});
          return renderPdf(pdf);
        }catch(e1c){ throw e1c; }
      }
    }
    // Not password: fallback to main thread
    try{
      const pdf = await tryOpen(bytes, {disableWorker:true});
      return renderPdf(pdf);
    }catch(e2){ throw e2; }
  }
}

function isPasswordError(err){
  const s = errString(err);
  return /Password|Incorrect Password|NEED_PASSWORD/i.test(s);
}

async function tryOpen(bytes, opts){
  const params = { data: bytes, disableWorker: !!opts.disableWorker };
  if(opts.password) params.password = opts.password;
  return pdfjsLib.getDocument(params).promise;
}

async function renderPdf(pdf){
  pdfContainer.innerHTML='';
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1.15});
    const c=document.createElement('canvas'); c.className='pdfpage'; c.width=vp.width; c.height=vp.height;
    await page.render({canvasContext:c.getContext('2d'), viewport:vp}).promise;
    const wrap=document.createElement('div'); wrap.className='page-wrap'; wrap.style.transform=`scale(${zoom})`;
    wrap.appendChild(c);
    wrap.appendChild(Object.assign(document.createElement('div'),{className:'overlay'}));
    pdfContainer.appendChild(wrap);
  }
}

/* ---------- Feather stamp generator for placed items ---------- */
function makeStampSvg(name, size=26){
  const NS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(NS,'svg');
  svg.setAttribute('viewBox','0 0 24 24');
  svg.setAttribute('width', String(size));
  svg.setAttribute('height', String(size));
  svg.setAttribute('fill','none');
  svg.setAttribute('stroke','currentColor');
  svg.setAttribute('stroke-width','2');
  svg.setAttribute('stroke-linecap','round');
  svg.setAttribute('stroke-linejoin','round');
  const path=(d)=>{const p=document.createElementNS(NS,'path'); p.setAttribute('d',d); return p;};
  const circle=(r=10)=>{const c=document.createElementNS(NS,'circle'); c.setAttribute('cx','12'); c.setAttribute('cy','12'); c.setAttribute('r',String(r)); return c;};
  const rect=()=>{const r=document.createElementNS(NS,'rect'); r.setAttribute('x','3'); r.setAttribute('y','3'); r.setAttribute('width','18'); r.setAttribute('height','18'); r.setAttribute('rx','2'); r.setAttribute('ry','2'); return r;};
  if(name==='check-circle'){ svg.append(circle()); svg.append(path('M9 12l2 2 4-4')); }
  else if(name==='x'){ svg.append(path('M18 6L6 18')); svg.append(path('M6 6L18 18')); }
  else { svg.append(rect()); }
  return svg;
}

/* ---------- stamps ---------- */
stampModal.addEventListener('click',(e)=>{
  const chip=e.target.closest('[data-stamp]'); if(!chip) return;
  const st=chip.dataset.stamp; currentMode='stamp-'+st; stampModal.classList.remove('active');
  drawFeather(stampModal);
  toast('Double-tap to place '+(st==='check'?'✓':st==='x'?'✕':'box'));
});

/* ---------- placement: double-click + double-tap ---------- */
pdfContainer.addEventListener('dblclick', (e)=> placeAt(e.clientX, e.clientY, e.target));
let lastTap=0;
pdfContainer.addEventListener('touchend',(e)=>{
  const now=Date.now();
  if(now-lastTap<300){ const t=e.changedTouches[0]; const tgt=document.elementFromPoint(t.clientX,t.clientY); placeAt(t.clientX,t.clientY,tgt); e.preventDefault(); }
  lastTap=now;
},{passive:false});

function getWrapScale(wrap){ const m=wrap.style.transform.match(/scale\(([^)]+)\)/); return m?parseFloat(m[1]):1; }

function placeAt(clientX, clientY, targetEl){
  if(!currentMode) return;
  const wrap=targetEl?.closest?.('.page-wrap'); if(!wrap) return;
  const canvas=wrap.querySelector('canvas.pdfpage'); if(!canvas) return;
  const rect=canvas.getBoundingClientRect();
  const scale=getWrapScale(wrap);
  const x=(clientX-rect.left)/scale, y=(clientY-rect.top)/scale;

  activeWrap=wrap; pushUndo(wrap);
  const ov=overlayOf(wrap);

  if(currentMode==='text'){
    const d=document.createElement('div');
    d.className='draggable text-anno'; d.contentEditable=true; d.textContent='Text';
    Object.assign(d.style,{ left:x+'px', top:y+'px', fontSize:TEXT_DEFAULTS.size+'px', fontFamily:TEXT_DEFAULTS.font });
    ov.appendChild(d); bindDrag(d);
  }else if(currentMode.startsWith('stamp-')){
    const nm=currentMode.split('-')[1];
    const icon=(nm==='check')?'check-circle':(nm==='x'?'x':'square');

    const box=document.createElement('div');
    box.className='draggable icon-anno';
    Object.assign(box.style,{left:x+'px', top:y+'px', position:'absolute', width:'26px', height:'26px'});

    const svg=makeStampSvg(icon,26); svg.style.width='100%'; svg.style.height='100%';
    box.appendChild(svg);

    ov.appendChild(box);
    bindDrag(box);
    bindPinchResize(box);
  }else if(currentMode==='sign' && signatureData){
    const box=document.createElement('div'); box.className='draggable resizable';
    Object.assign(box.style,{left:x+'px', top:y+'px', width:'180px', height:'80px'});
    const img=new Image(); img.src=signatureData; box.appendChild(img);
    ov.appendChild(box); bindDrag(box); bindPinchResize(box);
  }

  currentMode=null;
}

/* ---------- drag with text edit threshold ---------- */
function bindDrag(el){
  const isText = el.classList.contains('text-anno');
  let dragging=false, started=false, wrap=null, parent=null;
  let oX=0, oY=0, d0x=0, d0y=0;
  const DRAG_THRESHOLD=6;

  const onDown=(ev)=>{
    if(ev.touches && ev.touches.length>1) return; // allow pinch
    if(!isText) ev.preventDefault?.();
    started=true;
    wrap = el.closest('.page-wrap');
    parent = el.offsetParent || el.closest('.overlay') || wrap;
    activeWrap = wrap;

    const scale=getWrapScale(wrap);
    const pRect=parent.getBoundingClientRect();
    const cx=('clientX' in ev)?ev.clientX:(ev.touches&&ev.touches[0]?ev.touches[0].clientX:0);
    const cy=('clientY' in ev)?ev.clientY:(ev.touches&&ev.touches[0]?ev.touches[0].clientY:0);

    d0x=cx; d0y=cy;
    oX =cx - (el.offsetLeft*scale + pRect.left);
    oY =cy - (el.offsetTop *scale + pRect.top );

    window.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup',   onUp,   {passive:false});
    window.addEventListener('mousemove',   onMove, {passive:false});
    window.addEventListener('mouseup',     onUp,   {passive:false});
    window.addEventListener('touchmove',   onMove, {passive:false});
    window.addEventListener('touchend',    onUp,   {passive:false});
  };

  const onMove=(ev)=>{
    if(!started) return;
    const cx=('clientX' in ev)?ev.clientX:(ev.touches&&ev.touches[0]?ev.touches[0].clientX:0);
    const cy=('clientY' in ev)?ev.clientY:(ev.touches&&ev.touches[0]?ev.touches[0].clientY:0);

    const dx=cx-d0x, dy=cy-d0y, dist=Math.hypot(dx,dy);
    if(isText && !dragging){
      if(dist<DRAG_THRESHOLD) return;   // tap to edit
      dragging=true; ev.preventDefault?.(); pushUndo(wrap); el.blur?.();
    }else if(!isText && !dragging){
      dragging=true; ev.preventDefault?.(); pushUndo(wrap);
    }else{ ev.preventDefault?.(); }

    const scale=getWrapScale(wrap);
    const pRect=parent.getBoundingClientRect();
    const left=(cx - oX - pRect.left)/scale;
    const top =(cy - oY - pRect.top )/scale;

    el.style.left=Math.max(0,left)+'px';
    el.style.top =Math.max(0,top )+'px';
  };

  const cleanup=()=>{
    started=false; dragging=false;
    window.removeEventListener('pointermove', onMove);
    window.removeEventListener('pointerup',   onUp);
    window.removeEventListener('mousemove',   onMove);
    window.removeEventListener('mouseup',     onUp);
    window.removeEventListener('touchmove',   onMove);
    window.removeEventListener('touchend',    onUp);
  };

  const onUp=(ev)=>{
    if(isText && !dragging){ setTimeout(()=>{ try{ el.focus(); }catch{} }, 0); }
    cleanup();
  };

  el.addEventListener('pointerdown', onDown, {passive:false});
  el.addEventListener('mousedown',   onDown, {passive:false});
  el.addEventListener('touchstart',  onDown, {passive:false});
}

/* ---------- pinch resize for signatures & stamps ---------- */
function bindPinchResize(box){
  box.addEventListener('touchstart', (e)=>{
    if(e.touches.length!==2) return;
    e.preventDefault();
    const startDist=distance(e.touches[0], e.touches[1]);
    const startW=box.offsetWidth, startH=box.offsetHeight;
    const move=(ev)=>{
      if(ev.touches.length!==2) return;
      ev.preventDefault();
      const s=distance(ev.touches[0],ev.touches[1])/startDist;
      box.style.width = (startW*s)+'px';
      box.style.height = (startH*s)+'px';
      const svg=box.querySelector('svg'); if(svg){ svg.style.width='100%'; svg.style.height='100%'; }
    };
    const end=()=>{ document.removeEventListener('touchmove',move); document.removeEventListener('touchend',end); };
    document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',end);
  }, {passive:false});
}
function distance(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

/* ---------- desktop Alt+wheel resize for stamps & text ---------- */
document.addEventListener('wheel', (e)=>{
  if(!e.altKey) return;
  const el = e.target.closest?.('.draggable'); if(!el) return;
  e.preventDefault();
  const delta = Math.sign(e.deltaY) * -1; // up = increase
  if(el.classList.contains('text-anno')){
    const cs=getComputedStyle(el); const fz=parseFloat(cs.fontSize)||16;
    const next=Math.max(8, Math.min(128, fz + delta*1.5));
    el.style.fontSize = next+'px';
  }else{
    const w=el.offsetWidth, h=el.offsetHeight;
    const factor = 1 + (delta*0.1);
    el.style.width  = Math.max(16, w*factor) +'px';
    el.style.height = Math.max(16, h*factor)+'px';
    const svg=el.querySelector('svg'); if(svg){ svg.style.width='100%'; svg.style.height='100%'; }
  }
}, {passive:false});

/* ---------- text size via keyboard (focused) ---------- */
document.addEventListener('keydown', (e)=>{
  const t=document.activeElement;
  if(!t || !t.classList?.contains('text-anno')) return;
  if(!(e.ctrlKey||e.metaKey)) return;
  if(e.key==='=' || e.key==='+'){ e.preventDefault(); bumpTextSize(t, +1.5); }
  if(e.key==='-'){ e.preventDefault(); bumpTextSize(t, -1.5); }
});
function bumpTextSize(el, delta){
  const cs=getComputedStyle(el); const fz=parseFloat(cs.fontSize)||16;
  const next=Math.max(8, Math.min(128, fz + delta));
  el.style.fontSize = next+'px';
}

/* ---------- SETTINGS ---------- */
function openSettings(){
  sizeInput.value = TEXT_DEFAULTS.size; sizeVal.textContent = TEXT_DEFAULTS.size + ' px';
  fontSel.value = TEXT_DEFAULTS.font; refreshPreview();
  settingsModal.classList.add('active');
}
sizeInput.addEventListener('input', ()=>{ TEXT_DEFAULTS.size=+sizeInput.value; sizeVal.textContent=sizeInput.value+' px'; refreshPreview(); });
fontSel.addEventListener('change', ()=>{ TEXT_DEFAULTS.font=fontSel.value; refreshPreview(); });
document.getElementById('set-apply-all').addEventListener('click', ()=>{
  let count=0;
  document.querySelectorAll('.text-anno').forEach(el=>{
    el.style.fontSize = TEXT_DEFAULTS.size + 'px';
    el.style.fontFamily = TEXT_DEFAULTS.font;
    count++;
  });
  toast(`Applied to ${count} text item${count===1?'':'s'}`);
});
document.getElementById('set-close').addEventListener('click', ()=> settingsModal.classList.remove('active'));

/* ---------- help & modals click-outside ---------- */
document.getElementById('help-close').addEventListener('click',()=> helpModal.classList.remove('active'));
[stampModal, signModal, helpModal, settingsModal].forEach(m=>{
  m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('active'); });
});

/* ---------- zoom ---------- */
function setZoom(z){ zoom=Math.min(ZMAX, Math.max(ZMIN, z)); document.querySelectorAll('.page-wrap').forEach(w=> w.style.transform=`scale(${zoom})`); }

/* ---------- signature pad ---------- */
const spView=document.getElementById('sp-view'), spCtx=spView.getContext('2d');
const spColor=document.getElementById('sp-color'), spSize=document.getElementById('sp-size'), spSmooth=document.getElementById('sp-smooth');
let spMode='pen', spDrawing=false, spLast=null, spUndo=[], spRedo=[], SP_MAX=80;
function openSign(){ signModal.classList.add('active'); spCtx.lineCap='round'; spCtx.lineJoin='round'; }
function spPush(){ if(spUndo.length>=SP_MAX) spUndo.shift(); spUndo.push(spView.toDataURL()); spRedo.length=0; }
function spRestore(url){ return new Promise(r=>{ const img=new Image(); img.onload=()=>{ spCtx.clearRect(0,0,spView.width,spView.height); spCtx.drawImage(img,0,0,spView.width,spView.height); r(); }; img.src=url; }); }
function spPos(ev){ const r=spView.getBoundingClientRect(); return {x:ev.clientX-r.left, y:ev.clientY-r.top}; }
function lerp(a,b,t){return a+(b-a)*t} function bias(t,k){const p=Math.max(.0001,1-k); return Math.pow(t,p)}
function spBegin(x,y){ spPush(); spCtx.save(); spCtx.globalCompositeOperation=spMode==='eraser'?'destination-out':'source-over'; spCtx.strokeStyle=spMode==='eraser'?'#000':spColor.value; spCtx.lineWidth=+spSize.value; spCtx.beginPath(); spCtx.moveTo(x,y); spDrawing=true; spLast={x,y}; }
function spLineTo(x,y){ const p0=spLast||{x,y}, p1={x,y}; const steps=Math.max(1,Math.ceil(Math.hypot(p1.x-p0.x,p1.y-p0.y)/2)); for(let i=1;i<=steps;i++){ const t=i/steps, tt=+spSmooth.value?bias(t,+spSmooth.value):t; spCtx.lineTo(lerp(p0.x,p1.x,tt), lerp(p0.y,p1.y,tt)); } spCtx.stroke(); spLast=p1; }
function spEnd(){ if(!spDrawing) return; spCtx.closePath(); spCtx.restore(); spDrawing=false; spLast=null; }
spView.addEventListener('pointerdown', (e)=>{ e.preventDefault(); spView.setPointerCapture?.(e.pointerId); const p=spPos(e); spBegin(p.x,p.y); });
spView.addEventListener('pointermove', (e)=>{ if(!spDrawing) return; e.preventDefault(); const p=spPos(e); spLineTo(p.x,p.y); });
['pointerup','pointercancel','pointerleave'].forEach(type=> spView.addEventListener(type, (e)=>{ if(spDrawing){ e.preventDefault(); spEnd(); } }));
signModal.addEventListener('click', async (e)=>{
  const b=e.target.closest('[data-sp]'); if(!b) return;
  const a=b.dataset.sp;
  if(a==='pen') spMode='pen';
  else if(a==='eraser') spMode='eraser';
  else if(a==='undo'){ if(spUndo.length){ const s=spUndo.pop(); spRedo.push(spView.toDataURL()); await spRestore(s);} }
  else if(a==='redo'){ if(spRedo.length){ const s=spRedo.pop(); spUndo.push(spView.toDataURL()); await spRestore(s);} }
  else if(a==='clear'){ spPush(); spCtx.clearRect(0,0,spView.width,spView.height); }
});
document.getElementById('sp-ok').addEventListener('click',()=>{ signatureData=spView.toDataURL('image/png'); signModal.classList.remove('active'); currentMode='sign'; toast('Double-tap to place signature'); });
document.getElementById('sp-cancel').addEventListener('click',()=> signModal.classList.remove('active'));

/* ---------- SVG → canvas (for export) ---------- */
async function drawSvgToCtx(svg, ctx, x, y, w, h){
  const clone=svg.cloneNode(true);
  clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
  clone.setAttribute('width',w+'px'); clone.setAttribute('height',h+'px');
  const txt=new XMLSerializer().serializeToString(clone);
  const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(txt);
  await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>{ ctx.drawImage(im,x,y,w,h); res(); }; im.onerror=rej; im.src=url; });
}

/* ---------- save (iOS Share + desktop download) ---------- */
async function savePdf(){
  try{
    const pdfDoc=await PDFLib.PDFDocument.create();
    for(const wrap of pdfContainer.children){
      const pageCanvas=wrap.querySelector('canvas.pdfpage'); if(!pageCanvas) continue;
      const page=pdfDoc.addPage([pageCanvas.width, pageCanvas.height]);

      const comp=document.createElement('canvas'); comp.width=pageCanvas.width; comp.height=pageCanvas.height;
      const ctx=comp.getContext('2d'); ctx.drawImage(pageCanvas,0,0);

      const ov=overlayOf(wrap);
      const pr=pageCanvas.getBoundingClientRect();
      const scale=getWrapScale(wrap);
      const sx=pageCanvas.width/(pr.width/scale), sy=pageCanvas.height/(pr.height/scale);

      const items=[...ov.querySelectorAll('.draggable')];
      for(const el of items){
        const er=el.getBoundingClientRect();
        const x=(er.left - pr.left)/scale * sx;
        const y=(er.top  - pr.top )/scale * sy;
        const w=(er.width )/scale * sx;
        const h=(er.height)/scale * sy;

        const img=el.querySelector?.('img');
        if(img){ ctx.drawImage(img,x,y,w,h); continue; }

        if(el.classList.contains('text-anno')){
          const cs=getComputedStyle(el); const fz=parseInt(cs.fontSize)||16;
          ctx.font=fz+'px '+(cs.fontFamily||'Arial'); ctx.fillStyle=cs.color||'#000'; ctx.textBaseline='top';
          ctx.fillText(el.textContent||'', x, y); continue;
        }
        if(el.tagName?.toLowerCase()==='svg'){ await drawSvgToCtx(el, ctx, x, y, w||24, h||24); continue; }
        const childSvg = el.querySelector && el.querySelector('svg');
        if(childSvg){ await drawSvgToCtx(childSvg, ctx, x, y, w||24, h||24); continue; }
      }

      const jpg=await pdfDoc.embedJpg(comp.toDataURL('image/jpeg',0.95));
      page.drawImage(jpg,{x:0,y:0,width:pageCanvas.width,height:pageCanvas.height});
    }

    const bytes = await pdfDoc.save();
    const blob = new Blob([bytes], { type: "application/pdf" });
    const fname = (openedFileName||'signed')+'.signed.pdf';

    const canShareFile = !!(navigator.share && navigator.canShare && (()=>{try{
      return navigator.canShare({ files: [new File([blob], fname, {type:'application/pdf'})] });
    }catch(_){ return false; }})());
    if (canShareFile) {
      try {
        await navigator.share({
          files: [new File([blob], fname, { type:'application/pdf' })],
          title: 'TurboSign PDF',
          text: 'Annotated PDF from TurboSign'
        });
        toast('Shared to Files', 'ok'); return;
      } catch(e){ /* canceled/fail -> fallback */ }
    }
    if (window.navigator && typeof window.navigator.msSaveOrOpenBlob === 'function') {
      window.navigator.msSaveOrOpenBlob(blob, fname); return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = fname;
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
      const w = window.open(url, "_blank"); if (!w) window.location.href = url;
      toast('Opened PDF — Share ▶︎ Save to Files', 'ok', 2500);
    } else { a.click(); }
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  }catch(e){ logError('[Save PDF] Error', e); toast('Save failed','err',2200); }
}

/* ---------- keyboard zoom (desktop) ---------- */
document.addEventListener('keydown',(e)=>{
  if(e.ctrlKey && (e.key==='='||e.key==='+')){ e.preventDefault(); setZoom(zoom+ZSTEP); }
  if(e.ctrlKey && (e.key==='-'          )){ e.preventDefault(); setZoom(zoom-ZSTEP); }
});

/* ----- Hidden diagnostics (no UI): Alt+Shift+D prints engine state; Alt+Shift+T creates a tiny test PDF ----- */
document.addEventListener('keydown',(e)=>{
  if(e.altKey && e.shiftKey && (e.key.toLowerCase()==='d')){
    console.groupCollapsed('[Diagnostics]');
    console.log('pdfjsLib:', !!window.pdfjsLib);
    console.log('workerSrc:', (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions && pdfjsLib.GlobalWorkerOptions.workerSrc) || '(unset)');
    console.log('userAgent:', navigator.userAgent);
    console.groupEnd();
    toast('Diagnostics printed to console');
  }
  if(e.altKey && e.shiftKey && (e.key.toLowerCase()==='t')){
    (async()=>{
      try{
        await ensurePdfEngine();
        const doc = await PDFLib.PDFDocument.create();
        const p = doc.addPage([400,300]); p.drawText('TurboSign self-test', {x:20,y:280,size:16});
        const bytes = await doc.save();
        await openAndRender(bytes);
        toast('Self-test OK');
      }catch(err){ logError('[Self-test] Error', err); toast('Self-test failed','err',2200); }
    })();
  }
});
</script>
</body>
</html>
