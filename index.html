<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TurboSign — PDF Annotator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  :root{
    --bg:#0f131a; --fg:#e9eef5; --panel:rgba(255,255,255,.08); --border:rgba(255,255,255,.14);
    --btn:#1c2430; --btn-hov:#263244; --icon:#e9eef5; --canvas-bg:#fff;
    --ok:#16a34a; --err:#ef4444; --hint:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--fg)}

  /* Toolbar — centered; scrolls horizontally on narrow screens */
  #toolbar{
    position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; padding:10px; border-radius:28px; z-index:40;
    background:var(--panel); border:1px solid var(--border); backdrop-filter:blur(10px);
    max-width:95vw; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  #toolbar::-webkit-scrollbar{ display:none }

  .btn{
    appearance:none; border:1px solid var(--border); background:var(--btn); color:var(--icon);
    width:52px; height:52px; border-radius:50%; display:grid; place-items:center;
    cursor:pointer; transition:background .2s, transform .08s; flex:0 0 auto;
  }
  .btn:hover{ background:var(--btn-hov) }
  .btn:active{ transform:translateY(1px) }
  .btn svg{ width:22px; height:22px; stroke:var(--icon) }
  @media (max-width:480px){ .btn{ width:46px; height:46px } .btn svg{ width:20px; height:20px } }

  #pdf-container{ position:relative; min-height:60vh; padding-bottom:110px }
  .page-wrap{ position:relative; width:max(320px, 72vw); margin:28px auto; transform-origin:0 0 }
  canvas.pdfpage{ display:block; width:100%; height:auto; background:var(--canvas-bg); border-radius:6px }
  .overlay{ position:absolute; inset:0; }
  .draggable{ position:absolute; cursor:move; user-select:none; color:#000; touch-action:none }
  .text-anno{ font:16px Arial, sans-serif; color:#000; padding:2px 4px; background:transparent; min-width:10px; min-height:16px }
  .icon-anno svg{ width:26px; height:26px; }
  .resizable{ border:1px dashed #9aa; background:transparent; resize:both; overflow:hidden }
  .resizable img{ width:100%; height:100%; display:block }

  .modal{
    display:none; position:fixed; inset:50% auto auto 50%; transform:translate(-50%,-50%);
    z-index:50; background:color-mix(in oklab, var(--bg) 90%, #0000); color:var(--fg);
    border:1px solid var(--border); border-radius:14px; width:min(92vw,540px); max-height:90vh; overflow:auto;
    box-shadow:0 10px 40px rgba(0,0,0,.45); padding:14px
  }
  .modal.active{ display:block }
  .modal h3{ margin:8px 0 10px; font-size:18px }
  .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .chip{ appearance:none; border:1px solid var(--border); background:var(--btn); color:var(--icon); border-radius:10px; padding:8px 10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer }
  .chip svg{ width:18px; height:18px }
  .kbd{ font:12px/1.8 ui-monospace,Menlo,Consolas,monospace; background:#1f2937; color:#dbeafe; padding:0 6px; border-radius:6px; border:1px solid #334155 }
  .help p{ margin:.4rem 0 } .help li{ margin:.25rem 0 }

  #toast{ position:fixed; top:12px; left:50%; transform:translateX(-50%);
    background:#0b1020d0; color:#eaf2ff; padding:8px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.18); z-index:60; font-size:13px; display:none }
  #toast.show{ display:block; animation:fade .2s ease-out }
  #toast.ok{ box-shadow:0 0 0 1px var(--ok) inset } #toast.err{ box-shadow:0 0 0 1px var(--err) inset }
  @keyframes fade{ from{opacity:0; transform:translateX(-50%) translateY(-6px)} to{opacity:1} }
</style>
</head>
<body>
  <!-- Hidden input -->
  <input id="file-input" type="file" accept="application/pdf,.pdf" style="display:none" />

  <!-- Toolbar -->
  <div id="toolbar" aria-label="Tools">
    <button class="btn" data-act="open" title="Open PDF"><i data-feather="folder"></i></button>
    <button class="btn" data-act="text" title="Text"><i data-feather="type"></i></button>
    <button class="btn" data-act="stamp" title="Stamp (✓/✕/□)"><i data-feather="check-circle"></i></button>
    <button class="btn" data-act="sign" title="Signature"><i data-feather="edit-2"></i></button>
    <button class="btn" data-act="zoomin" title="Zoom In"><i data-feather="zoom-in"></i></button>
    <button class="btn" data-act="zoomout" title="Zoom Out"><i data-feather="zoom-out"></i></button>
    <button class="btn" data-act="undo" title="Undo"><i data-feather="rotate-ccw"></i></button>
    <button class="btn" data-act="redo" title="Redo"><i data-feather="rotate-cw"></i></button>
    <button class="btn" data-act="help" title="Help"><i data-feather="help-circle"></i></button>
    <button class="btn" data-act="save" title="Save PDF"><i data-feather="download"></i></button>
  </div>

  <div id="pdf-container"></div>

  <!-- Stamp picker -->
  <div id="stamp-modal" class="modal">
    <h3>Choose a stamp</h3>
    <div class="row">
      <button class="chip" data-stamp="check"><i data-feather="check-circle"></i> Check</button>
      <button class="chip" data-stamp="x"><i data-feather="x"></i> Cross</button>
      <button class="chip" data-stamp="square"><i data-feather="square"></i> Box</button>
    </div>
  </div>

  <!-- Signature pad -->
  <div id="sign-modal" class="modal">
    <h3>Signature</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="chip" data-sp="pen"><i data-feather="edit"></i> Pen</button>
      <button class="chip" data-sp="eraser"><i data-feather="eraser"></i> Eraser</button>
      <button class="chip" data-sp="undo"><i data-feather="rotate-ccw"></i> Undo</button>
      <button class="chip" data-sp="redo"><i data-feather="rotate-cw"></i> Redo</button>
      <button class="chip" data-sp="clear"><i data-feather="trash-2"></i> Clear</button>
    </div>
    <div class="row" style="gap:10px; margin-bottom:8px">
      <label class="chip"> Color <input id="sp-color" type="color" value="#000000" style="margin-left:8px"/></label>
      <label class="chip"> Size <input id="sp-size" type="range" min="1" max="48" value="4" style="margin-left:8px"/></label>
      <label class="chip"> Smooth <input id="sp-smooth" type="range" min="0" max="0.9" step="0.05" value="0.5" style="margin-left:8px"/></label>
    </div>
    <div class="row" style="gap:0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff;">
      <canvas id="sp-view" width="360" height="160" style="display:block; max-width:100%; height:auto; background:#fff;"></canvas>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="chip" id="sp-ok"><i data-feather="check"></i> Use</button>
      <button class="chip" id="sp-cancel"><i data-feather="x-circle"></i> Close</button>
    </div>
  </div>

  <!-- Help -->
  <div id="help-modal" class="modal help">
    <h3>How to use TurboSign</h3>
    <p><b>Open:</b> click the <span class="kbd">folder</span> icon and choose a PDF.</p>
    <ul>
      <li><b>Place items:</b> choose <em>Text</em>, <em>Stamp</em>, or <em>Signature</em>, then <b>double-tap</b> (or double-click) on the page.</li>
      <li><b>Move:</b> drag any item. <b>Resize signatures</b> by corner (desktop) or <b>pinch</b> on phones.</li>
      <li><b>Zoom:</b> use <span class="kbd">+</span>/<span class="kbd">−</span> buttons. (Annotations scale with the page.)</li>
      <li><b>Undo/Redo:</b> toolbar arrows.</li>
      <li><b>Save:</b> flattens everything into a new PDF (no borders around signatures).</li>
    </ul>
    <div class="row" style="margin-top:8px"><button class="chip" id="help-close"><i data-feather="x-circle"></i> Close</button></div>
  </div>

  <div id="toast"></div>

  <!-- Version-pinned libs (order matters). -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    } else {
      console.error("PDF.js failed to load — check network/CSP. pdfjsLib is undefined.");
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/feather-icons@4.29.2/dist/feather.min.js"></script>

<script>
/* ---------- icons ---------- */
function drawFeather(container=document){ if(window.feather?.replace){ feather.replace({container}); } }
document.addEventListener('DOMContentLoaded', ()=> drawFeather(document));

/* ---------- toast ---------- */
const toastEl=document.getElementById('toast');
function toast(msg,type='ok',ms=1400){ toastEl.textContent=msg; toastEl.className=''; toastEl.classList.add('show',type); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms); }

/* ---------- elements & state ---------- */
const fileInput = document.getElementById('file-input');
const pdfContainer = document.getElementById('pdf-container');
const stampModal = document.getElementById('stamp-modal');
const signModal = document.getElementById('sign-modal');
const helpModal = document.getElementById('help-modal');

let currentMode=null;        // 'text' | 'stamp-check' | 'stamp-x' | 'stamp-square' | 'sign'
let signatureData=null;      // dataURL
let activeWrap=null;
let openedFileName=null;
let zoom=1;                  // CSS zoom scale (applied to .page-wrap)
const ZMIN=.6, ZMAX=2.5, ZSTEP=0.15;

/* ---------- per-page history ---------- */
const historyMap=new Map(); const HMAX=60;
function ensureHist(w){ if(!historyMap.has(w)) historyMap.set(w,{undo:[],redo:[]}); return historyMap.get(w); }
function overlayOf(w){ let ov=w.querySelector('.overlay'); if(!ov){ov=document.createElement('div'); ov.className='overlay'; w.appendChild(ov);} return ov; }
function pushUndo(w){ const h=ensureHist(w); const ov=overlayOf(w); if(h.undo.length>=HMAX) h.undo.shift(); h.undo.push(ov.innerHTML); h.redo.length=0; }
function restoreOverlay(w,html){ const ov=overlayOf(w); ov.innerHTML=html||''; ov.querySelectorAll('.draggable').forEach(bindDrag); }

/* ---------- toolbar ---------- */
document.getElementById('toolbar').addEventListener('click', (e)=>{
  const btn=e.target.closest('.btn'); if(!btn) return;
  const act=btn.dataset.act;
  if(act==='open') fileInput.click();
  else if(act==='text'){ currentMode='text'; toast('Double-tap to place text'); }
  else if(act==='stamp'){ stampModal.classList.add('active'); }
  else if(act==='sign'){ openSign(); }
  else if(act==='zoomin'){ setZoom(zoom+ZSTEP); }
  else if(act==='zoomout'){ setZoom(zoom-ZSTEP); }
  else if(act==='undo'){ const w=activeWrap||pdfContainer.querySelector('.page-wrap'); if(!w) return; const h=ensureHist(w); if(h.undo.length){ const s=h.undo.pop(); h.redo.push(overlayOf(w).innerHTML); restoreOverlay(w,s);} }
  else if(act==='redo'){ const w=activeWrap||pdfContainer.querySelector('.page-wrap'); if(!w) return; const h=ensureHist(w); if(h.redo.length){ const s=h.redo.pop(); h.undo.push(overlayOf(w).innerHTML); restoreOverlay(w,s);} }
  else if(act==='help'){ helpModal.classList.add('active'); }
  else if(act==='save'){ savePdf(); }
});

/* ---------- open & render ---------- */
fileInput.addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file){return;}
  if(file.type!=='application/pdf'){ alert('Please choose a PDF'); return; }
  openedFileName=file.name.replace(/\.[Pp][Dd][Ff]$/,'');
  try{
    await renderPdf(await file.arrayBuffer());
    toast('PDF loaded');
  }catch(err){
    console.error(err); toast('Failed to open PDF','err',2000);
  }
});

function requirePdfJs(){
  if(!window.pdfjsLib){
    toast('PDF.js not available', 'err', 2200);
    throw new Error('PDF.js not available (pdfjsLib is undefined). Ensure the CDN script loaded.');
  }
}

async function renderPdf(bytes){
  requirePdfJs();
  // try worker; if that fails (CSP, 3rd-party block), fall back to main thread
  let pdf; try{
    pdf = await pdfjsLib.getDocument({data:bytes, disableWorker:false}).promise;
  }catch{ pdf = await pdfjsLib.getDocument({data:bytes, disableWorker:true}).promise; }

  pdfContainer.innerHTML='';
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const vp=page.getViewport({scale:1.15});
    const c=document.createElement('canvas'); c.className='pdfpage'; c.width=vp.width; c.height=vp.height;
    await page.render({canvasContext:c.getContext('2d'), viewport:vp}).promise;
    const wrap=document.createElement('div'); wrap.className='page-wrap'; wrap.style.transform=`scale(${zoom})`;
    wrap.appendChild(c);
    wrap.appendChild(Object.assign(document.createElement('div'),{className:'overlay'}));
    pdfContainer.appendChild(wrap);
  }
}

/* ---------- stamps ---------- */
stampModal.addEventListener('click',(e)=>{
  const chip=e.target.closest('[data-stamp]'); if(!chip) return;
  const st=chip.dataset.stamp; currentMode='stamp-'+st; stampModal.classList.remove('active');
  toast('Double-tap to place '+(st==='check'?'✓':st==='x'?'✕':'box'));
});

/* ---------- placement (double-tap) ---------- */
pdfContainer.addEventListener('dblclick', (e)=> placeAt(e.clientX, e.clientY, e.target));
let lastTap=0;
pdfContainer.addEventListener('touchend',(e)=>{
  const now=Date.now();
  if(now-lastTap<300){ const t=e.changedTouches[0]; const tgt=document.elementFromPoint(t.clientX,t.clientY); placeAt(t.clientX,t.clientY,tgt); e.preventDefault(); }
  lastTap=now;
},{passive:false});

function getWrapScale(wrap){ const m=wrap.style.transform.match(/scale\(([^)]+)\)/); return m?parseFloat(m[1]):1; }

function placeAt(clientX, clientY, targetEl){
  if(!currentMode) return;
  const wrap=targetEl?.closest?.('.page-wrap'); if(!wrap) return;
  const canvas=wrap.querySelector('canvas.pdfpage'); if(!canvas) return;
  const rect=canvas.getBoundingClientRect();
  const scale=getWrapScale(wrap); // current CSS scale
  const x=(clientX-rect.left)/scale, y=(clientY-rect.top)/scale;

  activeWrap=wrap; pushUndo(wrap);
  const ov=overlayOf(wrap);

  if(currentMode==='text'){
    const d=document.createElement('div');
    d.className='draggable text-anno'; d.contentEditable=true; d.textContent='Text';
    Object.assign(d.style,{left:x+'px', top:y+'px'});
    ov.appendChild(d); bindDrag(d);
  }else if(currentMode.startsWith('stamp-')){
    const nm=currentMode.split('-')[1];
    const i=document.createElement('i');
    i.setAttribute('data-feather', nm==='check'?'check-circle': nm==='x'?'x':'square');
    i.style.position='absolute';
    i.style.left=x+'px'; i.style.top=y+'px';
    ov.appendChild(i);
    drawFeather(ov);
    // Feather replaces <i> with <svg>. Grab the newly inserted SVG (last-of-type in overlay)
    const svg=ov.querySelector('svg:last-of-type');
    if(svg){
      svg.classList.add('draggable','icon-anno');
      svg.style.position='absolute';
      svg.style.left=x+'px';
      svg.style.top=y+'px';
      bindDrag(svg);               // <-- now stamps are draggable
    }
  }else if(currentMode==='sign' && signatureData){
    const box=document.createElement('div'); box.className='draggable resizable';
    Object.assign(box.style,{left:x+'px', top:y+'px', width:'180px', height:'80px'});
    const img=new Image(); img.src=signatureData; box.appendChild(img);
    ov.appendChild(box); bindDrag(box); bindPinchResize(box);
  }

  currentMode=null;
}

/* ---------- drag (mouse + touch), scale-aware ---------- */
function bindDrag(el){
  let dragging=false, oX=0, oY=0, wrap=null;
  const down=(e)=>{ const t=e.touches?e.touches[0]:e; wrap=el.closest('.page-wrap'); activeWrap=wrap; pushUndo(wrap);
    const scale=getWrapScale(wrap); dragging=true; oX=t.clientX - (el.offsetLeft*scale + wrap.getBoundingClientRect().left); oY=t.clientY - (el.offsetTop*scale + wrap.getBoundingClientRect().top);
    document.addEventListener('mousemove',move); document.addEventListener('mouseup',up);
    document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',up);
  };
  const move=(e)=>{ if(!dragging) return; const t=e.touches?e.touches[0]:e; const scale=getWrapScale(wrap); e.preventDefault?.();
    const rect=wrap.getBoundingClientRect(); const left=(t.clientX - oX - rect.left)/scale; const top=(t.clientY - oY - rect.top)/scale;
    el.style.left=Math.max(0,left)+'px'; el.style.top=Math.max(0,top)+'px';
  };
  const up=()=>{ dragging=false;
    document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',move); document.removeEventListener('touchend',up);
  };
  el.addEventListener('mousedown',down); el.addEventListener('touchstart',down,{passive:false});
}

/* ---------- pinch resize for signatures on mobile ---------- */
function bindPinchResize(box){
  box.addEventListener('touchstart', (e)=>{
    if(e.touches.length!==2) return;
    e.preventDefault();
    const startDist=dist(e.touches[0], e.touches[1]);
    const startW=box.offsetWidth, startH=box.offsetHeight;
    const move=(ev)=>{
      if(ev.touches.length!==2) return;
      ev.preventDefault();
      const s=dist(ev.touches[0],ev.touches[1])/startDist;
      box.style.width = (startW*s)+'px';
      box.style.height = (startH*s)+'px';
    };
    const end=()=>{ document.removeEventListener('touchmove',move); document.removeEventListener('touchend',end); };
    document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',end);
  }, {passive:false});
}
function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

/* ---------- signature pad ---------- */
const spView=document.getElementById('sp-view'), spCtx=spView.getContext('2d');
const spColor=document.getElementById('sp-color'), spSize=document.getElementById('sp-size'), spSmooth=document.getElementById('sp-smooth');
let spMode='pen', spDrawing=false, spLast=null, spUndo=[], spRedo=[], SP_MAX=80;
function openSign(){ signModal.classList.add('active'); spCtx.lineCap='round'; spCtx.lineJoin='round'; }
function spPush(){ if(spUndo.length>=SP_MAX) spUndo.shift(); spUndo.push(spView.toDataURL()); spRedo.length=0; }
function spRestore(url){ return new Promise(r=>{ const img=new Image(); img.onload=()=>{ spCtx.clearRect(0,0,spView.width,spView.height); spCtx.drawImage(img,0,0,spView.width,spView.height); r(); }; img.src=url; }); }
function pos(e){ const r=spView.getBoundingClientRect(); const t=e.touches?.[0]||e; return {x:t.clientX-r.left, y:t.clientY-r.top}; }
function lerp(a,b,t){return a+(b-a)*t} function bias(t,k){const p=Math.max(.0001,1-k); return Math.pow(t,p)}
function begin(x,y){ spPush(); spCtx.save(); spCtx.globalCompositeOperation=spMode==='eraser'?'destination-out':'source-over'; spCtx.strokeStyle=spMode==='eraser'?'#000':spColor.value; spCtx.lineWidth=+spSize.value; spCtx.beginPath(); spCtx.moveTo(x,y); spDrawing=true; spLast={x,y}; }
function lineTo(x,y){ const p0=spLast||{x,y}, p1={x,y}; const steps=Math.max(1,Math.ceil(Math.hypot(p1.x-p0.x,p1.y-p0.y)/2)); for(let i=1;i<=steps;i++){ const t=i/steps, tt=+spSmooth.value?bias(t,+spSmooth.value):t; spCtx.lineTo(lerp(p0.x,p1.x,tt), lerp(p0.y,p1.y,tt)); } spCtx.stroke(); spLast=p1; }
function end(){ if(!spDrawing) return; spCtx.closePath(); spCtx.restore(); spDrawing=false; spLast=null; }
spView.addEventListener('mousedown',e=>{const p=pos(e); begin(p.x,p.y)}); window.addEventListener('mousemove',e=>{if(!spDrawing)return; const p=pos(e); lineTo(p.x,p.y)}); window.addEventListener('mouseup',end);
spView.addEventListener('touchstart',e=>{const p=pos(e); begin(p.x,p.y); e.preventDefault()},{passive:false});
spView.addEventListener('touchmove',e=>{if(!spDrawing)return; const p=pos(e); lineTo(p.x,p.y); e.preventDefault()},{passive:false});
spView.addEventListener('touchend',e=>{end(); e.preventDefault()},{passive:false});
signModal.addEventListener('click', async (e)=>{
  const b=e.target.closest('[data-sp]'); if(!b) return;
  const a=b.dataset.sp;
  if(a==='pen') spMode='pen';
  else if(a==='eraser') spMode='eraser';
  else if(a==='undo'){ if(spUndo.length){ const s=spUndo.pop(); spRedo.push(spView.toDataURL()); await spRestore(s);} }
  else if(a==='redo'){ if(spRedo.length){ const s=spRedo.pop(); spUndo.push(spView.toDataURL()); await spRestore(s);} }
  else if(a==='clear'){ spPush(); spCtx.clearRect(0,0,spView.width,spView.height); }
});
document.getElementById('sp-ok').addEventListener('click',()=>{ signatureData=spView.toDataURL('image/png'); signModal.classList.remove('active'); currentMode='sign'; toast('Double-tap to place signature'); });
document.getElementById('sp-cancel').addEventListener('click',()=> signModal.classList.remove('active'));

/* ---------- help ---------- */
document.getElementById('help-close').addEventListener('click',()=> helpModal.classList.remove('active'));

/* ---------- zoom ---------- */
function setZoom(z){
  zoom=Math.min(ZMAX, Math.max(ZMIN, z));
  document.querySelectorAll('.page-wrap').forEach(w=> w.style.transform=`scale(${zoom})`);
}

/* ---------- export ---------- */
async function drawSvgToCtx(svg, ctx, x, y, w, h){
  const clone=svg.cloneNode(true);
  clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
  clone.setAttribute('width',w+'px'); clone.setAttribute('height',h+'px');
  const txt=new XMLSerializer().serializeToString(clone);
  const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(txt);
  await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>{ ctx.drawImage(im,x,y,w,h); res(); }; im.onerror=rej; im.src=url; });
}

async function savePdf(){
  try{
    const pdfDoc=await PDFLib.PDFDocument.create();
    for(const wrap of pdfContainer.children){
      const pageCanvas=wrap.querySelector('canvas.pdfpage'); if(!pageCanvas) continue;
      const page=pdfDoc.addPage([pageCanvas.width, pageCanvas.height]);
      const comp=document.createElement('canvas'); comp.width=pageCanvas.width; comp.height=pageCanvas.height;
      const ctx=comp.getContext('2d'); ctx.drawImage(pageCanvas,0,0);
      const ov=overlayOf(wrap);
      const pr=pageCanvas.getBoundingClientRect();
      const scale=getWrapScale(wrap);
      const sx=pageCanvas.width/(pr.width/scale), sy=pageCanvas.height/(pr.height/scale);
      const items=[...ov.querySelectorAll('.draggable')];
      for(const el of items){
        const er=el.getBoundingClientRect();
        const x=(er.left - pr.left)/scale * sx;
        const y=(er.top  - pr.top )/scale * sy;
        const w=el.offsetWidth  * sx / scale;
        const h=el.offsetHeight * sy / scale;

        const img=el.querySelector?.('img');
        if(img){ ctx.drawImage(img,x,y,w,h); continue; } // signature only (no border)

        if(el.classList.contains('text-anno')){
          const cs=getComputedStyle(el); const fz=parseInt(cs.fontSize)||16;
          ctx.font=fz+'px '+(cs.fontFamily||'Arial'); ctx.fillStyle=cs.color||'#000'; ctx.textBaseline='top';
          ctx.fillText(el.textContent||'', x, y); continue;
        }
        if(el.tagName?.toLowerCase()==='svg'){ await drawSvgToCtx(el, ctx, x, y, w||24, h||24); continue; }
      }
      const jpg=await pdfDoc.embedJpg(comp.toDataURL('image/jpeg',0.95));
      page.drawImage(jpg,{x:0,y:0,width:pageCanvas.width,height:pageCanvas.height});
    }
    const a=document.createElement('a');
    a.href=await pdfDoc.saveAsBase64({dataUri:true});
    a.download=(openedFileName||'signed')+'.signed.pdf';
    a.click();
  }catch(e){ console.error(e); toast('Save failed','err',2000); }
}

/* ---------- modals click-outside close ---------- */
[stampModal, signModal, helpModal].forEach(m=>{
  m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('active'); });
});

/* ---------- keyboard zoom (optional desktop nicety) ---------- */
document.addEventListener('keydown',(e)=>{
  if(e.ctrlKey && (e.key==='='||e.key==='+')){ e.preventDefault(); setZoom(zoom+ZSTEP); }
  if(e.ctrlKey && (e.key==='-'          )){ e.preventDefault(); setZoom(zoom-ZSTEP); }
});
</script>
</body>
</html>
